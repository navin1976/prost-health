---
// Clinical Risk Visualization Component
// Evidence-based medical comparison with anime.js animations and Material Symbols
---

<!-- Import Material Symbols from Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="clinical-visualization-minimal scroll-animate-viz" id="clinical-viz">
  <!-- Professional Clinical Header -->
  <div class="viz-header-minimal scroll-animate-header">
    <div class="header-content-minimal">
      <h3 class="viz-title-minimal">Diagnostic Accuracy Comparison</h3>
      <p class="viz-subtitle-minimal">Clinical outcomes per 100 patients screened</p>
    </div>
    <div class="method-toggle-minimal scroll-animate-toggle">
      <button class="method-btn-minimal active" data-method="mri">
        <svg class="method-icon-minimal" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <span class="method-name-minimal">bpMRI-First</span>
      </button>
      <button class="method-btn-minimal" data-method="traditional">
        <svg class="method-icon-minimal" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
        <span class="method-name-minimal">PSA-First</span>
      </button>
    </div>
  </div>

  <!-- Clinical Metrics Summary -->
  <div class="metrics-summary scroll-viz-cards">
    <div class="metric-summary-card scroll-viz-card">
      <div class="metric-header-minimal">
        <div class="metric-icon-minimal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h4 class="metric-title-minimal">Detection Accuracy</h4>
      </div>
      <div class="metric-value-minimal" id="accuracy-value">96%</div>
      <p class="metric-description">Clinically significant prostate cancer identification</p>
    </div>

    <div class="metric-summary-card scroll-viz-card">
      <div class="metric-header-minimal">
        <div class="metric-icon-minimal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <h4 class="metric-title-minimal">Procedure Risk</h4>
      </div>
      <div class="metric-value-minimal" id="complication-value">2%</div>
      <p class="metric-description">Patients experiencing screening-related complications</p>
    </div>

    <div class="metric-summary-card scroll-viz-card">
      <div class="metric-header-minimal">
        <div class="metric-icon-minimal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h4 class="metric-title-minimal">False Positive Rate</h4>
      </div>
      <div class="metric-value-minimal" id="unnecessary-value">4%</div>
      <p class="metric-description">Unnecessary invasive procedures avoided</p>
    </div>
  </div>

  <!-- Expandable Details -->
  <div class="details-section">
    <button class="details-toggle" onclick="toggleVisualizationDetails()">
      <span class="toggle-text">View detailed breakdown</span>
      <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <polyline points="6,9 12,15 18,9"/>
      </svg>
    </button>
    
    <div class="expandable-visualization" id="viz-details">
      <!-- Detailed visualization content will be shown here -->
      <div class="detailed-grid">
        <div class="detail-card scroll-viz-card">
          <div class="detail-card-header">
            <div class="detail-icon-wrapper">
              <svg class="detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h5 class="detail-title">Detection Accuracy</h5>
          </div>
          <div class="detail-percentage" id="detail-accuracy">96%</div>
          <p class="detail-description">Clinically significant prostate cancer identification</p>
          <div class="icon-grid-spacious" id="accuracy-grid">
            <!-- Icons will be generated by JavaScript -->
          </div>
          <div class="grid-legend-spacious">
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon success">sentiment_satisfied</span>
              <span id="accuracy-legend-success">Detected (96)</span>
            </div>
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon danger">sentiment_very_dissatisfied</span>
              <span id="accuracy-legend-danger">Missed (4)</span>
            </div>
          </div>
        </div>

        <div class="detail-card scroll-viz-card">
          <div class="detail-card-header">
            <div class="detail-icon-wrapper">
              <svg class="detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <h5 class="detail-title">Procedure Safety</h5>
          </div>
          <div class="detail-percentage" id="detail-complications">2%</div>
          <p class="detail-description">Screening-related complications and adverse events</p>
          <div class="icon-grid-spacious" id="complication-grid">
            <!-- Icons will be generated by JavaScript -->
          </div>
          <div class="grid-legend-spacious">
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon success">check_circle</span>
              <span id="complications-legend-success">No Issues (98)</span>
            </div>
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon danger">report</span>
              <span id="complications-legend-danger">Complications (2)</span>
            </div>
          </div>
        </div>

        <div class="detail-card scroll-viz-card">
          <div class="detail-card-header">
            <div class="detail-icon-wrapper">
              <svg class="detail-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h5 class="detail-title">False Positive Rate</h5>
          </div>
          <div class="detail-percentage" id="detail-unnecessary">4%</div>
          <p class="detail-description">Unnecessary invasive procedures and interventions</p>
          <div class="icon-grid-spacious" id="unnecessary-grid">
            <!-- Icons will be generated by JavaScript -->
          </div>
          <div class="grid-legend-spacious">
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon success">thumb_up</span>
              <span id="unnecessary-legend-success">Appropriate (96)</span>
            </div>
            <div class="legend-item">
              <span class="material-symbols-outlined legend-icon warning">warning</span>
              <span id="unnecessary-legend-warning">Unnecessary (4)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Clinical Summary -->
      <div class="clinical-summary-minimal scroll-animate-summary">
        <div class="summary-content">
          <h4 class="summary-title">Clinical Significance</h4>
          <p class="summary-text" id="summary-text">
            MRI-first approach reduces unnecessary procedures by 70% while maintaining 96% sensitivity for clinically significant cancer.
          </p>
        </div>
        <div class="evidence-badge">
          <svg class="badge-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
          </svg>
          <span class="badge-text">Evidence-Based</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Minimal Clinical Visualization */
.clinical-visualization-minimal {
  background: white;
  border-radius: 8px;
  padding: 3rem;
  margin: 3rem 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid #E5E7EB;
}

.viz-header-minimal {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4rem;
  flex-wrap: wrap;
  gap: 2rem;
}

.header-content-minimal {
  flex: 1;
}

.viz-title-minimal {
  font-size: 1.75rem;
  font-weight: 300;
  color: var(--color-charcoal);
  margin: 0 0 0.5rem 0;
  letter-spacing: -0.02em;
}

.viz-subtitle-minimal {
  font-size: 1rem;
  color: var(--color-warm-gray);
  margin: 0;
  font-weight: 400;
}

.method-toggle-minimal {
  display: flex;
  background: #F9FAFB;
  border-radius: 6px;
  padding: 0.25rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #E5E7EB;
}

.method-btn-minimal {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 500;
  color: var(--color-warm-gray);
}

.method-btn-minimal:hover {
  background: white;
  color: var(--color-charcoal);
}

.method-btn-minimal.active {
  background: var(--color-accent);
  color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.method-icon-minimal {
  width: 1.25rem;
  height: 1.25rem;
}

.method-name-minimal {
  font-size: 0.95rem;
  font-weight: 500;
}

/* Metrics Summary */
.metrics-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.metric-summary-card {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: white;
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid #E5E7EB;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.metric-summary-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.metric-header-minimal {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}

.metric-icon-minimal {
  width: 2rem;
  height: 2rem;
  color: var(--color-accent);
  flex-shrink: 0;
}

.metric-title-minimal {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-charcoal);
  margin: 0;
}

.metric-value-minimal {
  font-size: 2rem;
  font-weight: 300;
  color: var(--color-accent);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.metric-description {
  font-size: 0.875rem;
  color: var(--color-warm-gray);
  line-height: 1.5;
  margin: 0;
}

/* Details Section */
.details-section {
  border-top: 1px solid rgba(226, 232, 240, 0.5);
  padding-top: 2rem;
}

.details-toggle {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: none;
  border: none;
  color: var(--color-accent);
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  padding: 1rem 0;
  margin: 0 auto;
  transition: all 0.3s ease;
}

.details-toggle:hover {
  color: var(--color-accent-hover);
}

.toggle-icon {
  width: 1.25rem;
  height: 1.25rem;
  transition: transform 0.3s ease;
}

.expandable-visualization {
  max-height: 0;
  overflow: hidden;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
}

.expandable-visualization.expanded {
  max-height: 2000px;
  opacity: 1;
  margin-top: 2rem;
}

.toggle-icon.expanded {
  transform: rotate(180deg);
}

/* Detailed Grid with Equal Height Cards */
.detailed-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
  align-items: stretch;
}

.detail-card {
  background: white;
  border-radius: 8px;
  padding: 1.5rem;
  border: 1px solid #E5E7EB;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: 100%;
  text-align: center;
}

.detail-card::before {
  display: none;
}

.detail-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.detail-card-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}

.detail-icon-wrapper {
  width: 2rem;
  height: 2rem;
  color: var(--color-accent);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.detail-icon {
  width: 2rem;
  height: 2rem;
  stroke-width: 2;
}

.detail-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-charcoal);
  margin: 0;
}

.detail-percentage {
  font-size: 2rem;
  font-weight: 300;
  color: var(--color-accent);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.detail-description {
  font-size: 0.875rem;
  color: var(--color-warm-gray);
  line-height: 1.5;
  margin: 0;
}

/* Full-width Icon Grid - 10x10 with smaller icons */
.icon-grid-spacious {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 0.125rem;
  margin: 0;
  width: 100%;
  max-width: none;
  padding: 0.5rem;
  background: #F9FAFB;
  border-radius: 6px;
  border: 1px solid #E5E7EB;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.grid-icon-spacious {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  background: white !important;
  border: 1px solid #D1D5DB;
  opacity: 0;
  transform: scale(0);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.grid-icon-spacious .material-symbols-outlined {
  font-size: 0.5rem;
  font-weight: 400;
  line-height: 1;
}

.grid-icon-spacious:hover {
  transform: scale(1.15) !important;
  border-color: var(--color-accent);
  background: #F3F4F6 !important;
  z-index: 10;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Improved Legend */
.grid-legend-spacious {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: #F9FAFB;
  border-radius: 6px;
  border: 1px solid #E5E7EB;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  margin: 0;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--color-warm-gray);
}

.legend-icon {
  font-size: 1.125rem !important;
}

.legend-icon.success {
  color: var(--color-sage);
}

.legend-icon.warning {
  color: var(--color-terracotta);
}

.legend-icon.danger {
  color: var(--color-error);
}

/* Clinical Summary */
.clinical-summary-minimal {
  background: var(--color-gray-50);
  border-radius: var(--radius-lg);
  padding: 2rem;
  color: var(--color-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 2rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--color-gray-200);
}

.summary-content {
  flex: 1;
}

.summary-title {
  font-size: 1.125rem;
  font-weight: 600;
  margin: 0 0 0.75rem 0;
  color: var(--color-primary);
}

.summary-text {
  font-size: 0.95rem;
  line-height: 1.6;
  margin: 0;
  color: var(--color-gray-700);
}

.evidence-badge {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: var(--color-white);
  padding: 1rem 1.5rem;
  border-radius: 6px;
  border: 1px solid var(--color-gray-200);
}

.badge-icon {
  width: 1.25rem;
  height: 1.25rem;
  fill: var(--color-accent);
}

.badge-text {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-primary);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .clinical-visualization-minimal {
    padding: 2rem;
    margin: 2rem 0;
    border-radius: 8px;
  }

  .viz-header-minimal {
    flex-direction: column;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }

  .method-toggle-minimal {
    width: 100%;
  }

  .method-btn-minimal {
    flex: 1;
    justify-content: center;
    padding: 0.875rem 1rem;
  }

  .metrics-summary {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  .metric-summary-card {
    padding: 1.5rem;
  }

  .detailed-grid {
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .detail-card {
    padding: 1.5rem;
  }

  .detail-percentage {
    font-size: 1.75rem;
  }

  .icon-grid-spacious {
    grid-template-columns: repeat(10, 1fr);
    gap: 0.125rem;
    padding: 0.5rem;
  }

  .grid-icon-spacious .material-symbols-outlined {
    font-size: 0.4375rem;
  }

  .grid-legend-spacious {
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }

  .clinical-summary-minimal {
    flex-direction: column;
    text-align: center;
    gap: 1.5rem;
    padding: 2rem;
  }

  .viz-title-minimal {
    font-size: 1.5rem;
  }

  .metric-value-minimal {
    font-size: 1.75rem;
  }
}

@media (max-width: 480px) {
  .icon-grid-spacious {
    grid-template-columns: repeat(10, 1fr);
    gap: 0.125rem;
    padding: 0.375rem;
  }

  .grid-icon-spacious .material-symbols-outlined {
    font-size: 0.375rem;
  }

  .detail-card {
    padding: 1.25rem;
  }

  .detail-percentage {
    font-size: 1.5rem;
  }
}
</style>

<script>
  // Removed anime.js dependency - using instant display instead
  console.log('RiskVisualization script loaded');

  // Global function for toggling visualization details
  window.toggleVisualizationDetails = function() {
    const details = document.getElementById('viz-details');
    const toggle = document.querySelector('.details-toggle');
    const icon = toggle.querySelector('.toggle-icon');
    const text = toggle.querySelector('.toggle-text');
    
    if (details.classList.contains('expanded')) {
      // Collapse
      details.classList.remove('expanded');
      icon.classList.remove('expanded');
      text.textContent = 'View detailed breakdown';
    } else {
      // Expand
      details.classList.add('expanded');
      icon.classList.add('expanded');
      text.textContent = 'Hide detailed breakdown';
      
      // Trigger animations for the detailed content
      setTimeout(() => {
        animateDetailedContent();
      }, 100);
    }
  };

  // Clinical data based on peer-reviewed medical evidence
  const clinicalData = {
    mri: {
      accuracy: {
        value: '96%',
        success: 96,  // 96% detection accuracy
        danger: 4,    // 4% missed cases
        icons: { 
          success: 'sentiment_satisfied', 
          danger: 'sentiment_very_dissatisfied' 
        }
      },
      complications: {
        value: '<2%',
        success: 98,  // 98% no complications
        danger: 2,    // 2% complication rate
        icons: { 
          success: 'check_circle', 
          danger: 'report' 
        }
      },
      unnecessary: {
        value: '4%',
        success: 96,  // 96% appropriate procedures
        warning: 4,   // 4% unnecessary procedures
        icons: { 
          success: 'thumb_up', 
          warning: 'warning' 
        }
      },
      summary: 'Bi-parametric MRI-first screening reduces unnecessary procedures by 70% while maintaining 96% sensitivity for clinically significant prostate cancer.'
    },
    traditional: {
      accuracy: {
        value: '75%',
        success: 75,  // 75% detection accuracy
        danger: 25,   // 25% missed cases
        icons: { 
          success: 'sentiment_satisfied', 
          danger: 'sentiment_very_dissatisfied' 
        }
      },
      complications: {
        value: '25%',
        success: 75,  // 75% no complications
        danger: 25,   // 25% complication rate
        icons: { 
          success: 'check_circle', 
          danger: 'report' 
        }
      },
      unnecessary: {
        value: '75%',
        success: 25,  // 25% appropriate procedures
        warning: 75,  // 75% unnecessary procedures
        icons: { 
          success: 'thumb_up', 
          warning: 'warning' 
        }
      },
      summary: 'PSA-first traditional screening results in 75% unnecessary procedures due to poor specificity and leads to higher complication rates from blind biopsies.'
    }
  };

  let currentMethod = 'mri';
  let isAnimating = false;
  let hasInitialized = false;

  // Create icon grid visualization with clustering and Material Symbols
  function createIconGrid(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container) {
      console.warn('Container not found:', containerId);
      return;
    }

    // Clear existing icons
    container.innerHTML = '';
    
    console.log(`Creating ${containerId} with ${data.success + (data.warning || 0) + (data.danger || 0)} icons`);
    
    const icons_array = [];
    
    // Create success icons first (clustered)
    for (let i = 0; i < (data.success || 0); i++) {
      icons_array.push({ 
        type: 'success', 
        icon: data.icons.success 
      });
    }
    
    // Add warning icons (clustered)
    for (let i = 0; i < (data.warning || 0); i++) {
      icons_array.push({ 
        type: 'warning', 
        icon: data.icons.warning 
      });
    }
    
    // Add danger icons (clustered)
    for (let i = 0; i < (data.danger || 0); i++) {
      icons_array.push({ 
        type: 'danger', 
        icon: data.icons.danger 
      });
    }
    
    // Create icon elements with colored Material Symbols
    icons_array.forEach((iconData, index) => {
      const icon = document.createElement('div');
      icon.className = `grid-icon-spacious ${iconData.type}`;
      
      // Determine color based on type
      let iconColor = '#059669'; // success green
      if (iconData.type === 'warning') iconColor = '#DC2626'; // red
      if (iconData.type === 'danger') iconColor = '#DC2626'; // red
      
      // Create span with inline style to force color
      icon.innerHTML = `<span class="material-symbols-outlined" style="color: ${iconColor} !important;">${iconData.icon}</span>`;
      icon.setAttribute('data-index', index);
      icon.setAttribute('data-type', iconData.type);
      
      container.appendChild(icon);
    });

    // Instantly show icons without animation
    console.log(`Showing ${containerId} icons`);
    anime({
      targets: `#${containerId} .grid-icon-spacious`,
      opacity: [0, 1],
      scale: [1, 1],
      duration: 0,
      easing: 'linear'
    });
  }

  // Animate detailed content when expanded
  function animateDetailedContent() {
    // Animation removed - cards appear instantly
  }

  // Update legend text to match current data
  function updateLegends(data) {
    // Update accuracy legends
    const accuracySuccess = document.getElementById('accuracy-legend-success');
    const accuracyDanger = document.getElementById('accuracy-legend-danger');
    if (accuracySuccess && accuracyDanger) {
      accuracySuccess.textContent = `Detected (${data.accuracy.success})`;
      accuracyDanger.textContent = `Missed (${data.accuracy.danger})`;
    }

    // Update complications legends
    const complicationsSuccess = document.getElementById('complications-legend-success');
    const complicationsDanger = document.getElementById('complications-legend-danger');
    if (complicationsSuccess && complicationsDanger) {
      complicationsSuccess.textContent = `No Issues (${data.complications.success})`;
      complicationsDanger.textContent = `Complications (${data.complications.danger})`;
    }

    // Update unnecessary procedure legends
    const unnecessarySuccess = document.getElementById('unnecessary-legend-success');
    const unnecessaryWarning = document.getElementById('unnecessary-legend-warning');
    if (unnecessarySuccess && unnecessaryWarning) {
      unnecessarySuccess.textContent = `Appropriate (${data.unnecessary.success})`;
      unnecessaryWarning.textContent = `Unnecessary (${data.unnecessary.warning})`;
    }
  }

  // Update visualization with anime.js transitions
  function updateVisualization(method) {
    if (isAnimating) {
      console.log('Animation already in progress, skipping...');
      return;
    }
    
    if (currentMethod === method && hasInitialized) {
      console.log('Already showing this method, skipping...');
      return;
    }
    
    isAnimating = true;
    currentMethod = method;
    const data = clinicalData[method];
    
    // Animate metric values in summary cards
    const accuracyValue = document.getElementById('accuracy-value');
    const complicationValue = document.getElementById('complication-value');
    const unnecessaryValue = document.getElementById('unnecessary-value');
    
    // Anime.js value animation - opacity only to prevent card collapse
    anime({
      targets: [accuracyValue, complicationValue, unnecessaryValue],
      opacity: [1, 0],
      duration: 200,
      easing: 'easeInQuad',
      complete: () => {
        accuracyValue.textContent = data.accuracy.value;
        complicationValue.textContent = data.complications.value;
        unnecessaryValue.textContent = data.unnecessary.value;
        
        anime({
          targets: [accuracyValue, complicationValue, unnecessaryValue],
          opacity: [0, 1],
          duration: 250,
          easing: 'easeOutQuad'
        });
      }
    });

    // Update detailed percentage displays
    const detailAccuracy = document.getElementById('detail-accuracy');
    const detailComplications = document.getElementById('detail-complications');
    const detailUnnecessary = document.getElementById('detail-unnecessary');
    
    if (detailAccuracy && detailComplications && detailUnnecessary) {
      anime({
        targets: [detailAccuracy, detailComplications, detailUnnecessary],
        opacity: [1, 0],
        duration: 200,
        easing: 'easeInQuad',
        complete: () => {
          detailAccuracy.textContent = data.accuracy.value;
          detailComplications.textContent = data.complications.value;
          detailUnnecessary.textContent = data.unnecessary.value;
          
          anime({
            targets: [detailAccuracy, detailComplications, detailUnnecessary],
            opacity: [0, 1],
            duration: 250,
            easing: 'easeOutQuad'
          });
        }
      });
    }
    
    // Animate summary text - opacity only to prevent layout shift
    const summaryText = document.getElementById('summary-text');
    anime({
      targets: summaryText,
      opacity: [1, 0],
      duration: 200,
      easing: 'easeInQuad',
      complete: () => {
        summaryText.textContent = data.summary;
        anime({
          targets: summaryText,
          opacity: [0, 1],
          duration: 250,
          easing: 'easeOutQuad'
        });
      }
    });
    
    // Animate out existing icons - FAST exit, no stagger
    const existingIcons = document.querySelectorAll('.grid-icon-spacious');
    if (existingIcons.length > 0 && hasInitialized) {
      console.log(`Exiting ${existingIcons.length} icons`);
      
      // First stop any running animations on these icons
      anime.remove(existingIcons);
      
      // Fade out and remove old icons WHILE keeping grid structure
      anime({
        targets: existingIcons,
        opacity: [1, 0],
        duration: 200,
        easing: 'easeInQuad',
        complete: () => {
          console.log('Exit complete, creating new grids');
          
          // Clear grids and immediately create new ones to maintain size
          document.getElementById('accuracy-grid').innerHTML = '';
          document.getElementById('complication-grid').innerHTML = '';
          document.getElementById('unnecessary-grid').innerHTML = '';
          
          // Create new grids immediately - no delays to prevent size changes
          createIconGrid('accuracy-grid', data.accuracy);
          createIconGrid('complication-grid', data.complications);
          createIconGrid('unnecessary-grid', data.unnecessary);

          // Update legend text to match the new data
          updateLegends(data);

          setTimeout(() => {
            console.log('Animation complete, unlocking');
            isAnimating = false;
          }, 1200);
        }
      });
    } else {
      // First time initialization
      console.log('First time init');

      setTimeout(() => createIconGrid('accuracy-grid', data.accuracy), 0);
      setTimeout(() => createIconGrid('complication-grid', data.complications), 200);
      setTimeout(() => createIconGrid('unnecessary-grid', data.unnecessary), 400);

      // Update legend text for initial display
      setTimeout(() => updateLegends(data), 400);

      hasInitialized = true;

      setTimeout(() => {
        isAnimating = false;
      }, 2500);
    }
    
    // Update button states with subtle animation
    document.querySelectorAll('.method-btn-minimal').forEach(btn => {
      if (btn.dataset.method === method) {
        btn.classList.add('active');
        anime({
          targets: btn,
          scale: [0.98, 1],
          duration: 200,
          easing: 'easeOutQuad'
        });
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Initialize visualization
  document.addEventListener('DOMContentLoaded', () => {
    // Set up button handlers
    document.querySelectorAll('.method-btn-minimal').forEach(btn => {
      btn.addEventListener('click', () => {
        updateVisualization(btn.dataset.method);
      });
    });
    
    // Use Intersection Observer to trigger animation when in view
    const vizContainer = document.getElementById('clinical-viz');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasInitialized) {
          console.log('Visualization entered view - initializing');
          // Trigger animation when 20% visible
          setTimeout(() => {
            updateVisualization('mri');
          }, 200);
          // Stop observing after first trigger
          observer.unobserve(vizContainer);
        }
      });
    }, {
      threshold: 0.2,
      rootMargin: '0px'
    });
    
    if (vizContainer) {
      observer.observe(vizContainer);
    }
    
    // Add subtle pulse animation to metric sections on hover
    document.querySelectorAll('.metric-summary-card').forEach(section => {
      section.addEventListener('mouseenter', () => {
        const icon = section.querySelector('.metric-icon-minimal');
        if (icon) {
          anime({
            targets: icon,
            scale: [1, 1.05, 1],
            duration: 400,
            easing: 'easeInOutQuad'
          });
        }
      });
    });
  });
</script>
